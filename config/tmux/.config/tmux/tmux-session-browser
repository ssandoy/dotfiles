#!/usr/bin/env bash
set -euo pipefail

DELIM='::'

if ! sessions=$(tmux list-sessions -F "#{session_name}::#{session_windows} windows::#{?session_attached,attached,detached}::#{session_created_string}" 2>/dev/null); then
    exit 0
fi

if [[ -z "${sessions}" ]]; then
    exit 0
fi

selected=$(
    printf "%s\n" "${sessions}" | fzf \
        --prompt 'tmux sessions > ' \
        --delimiter "${DELIM}" \
        --with-nth '1,2,3,4' \
        --preview 'tmux list-windows -t {1}' \
        --preview-window 'down,60%:wrap' \
        --exit-0
)

if [[ -z "${selected}" ]]; then
    exit 0
fi

session_name="${selected%%::*}"

if [[ -n "${TMUX-}" ]]; then
    tmux switch-client -t "${session_name}"
else
    tmux attach -t "${session_name}"
fi
